// Local Chart.js loader: prefer local UMD vendor bundles in ./vendor/ and fall back to CDN
(function(){
  if (window.__chartLoaderRun) return; window.__chartLoaderRun = true;
  if (typeof Chart !== 'undefined') return; // Chart already available (e.g., loaded elsewhere)
  console.info('Local chart.min.js is a loader: will prefer local vendor bundles if present.');

  var localChart = 'vendor/chart.umd.min.js';
  var localDateFns = 'vendor/date-fns.min.js';
  var localAdapter = 'vendor/chartjs-adapter-date-fns.min.js';
  var localAdapterBundle = 'vendor/chartjs-adapter-date-fns.bundle.min.js';

  function loadScript(src, onload, onerror){
    var s = document.createElement('script'); s.src = src; s.onload = onload; s.onerror = onerror; document.head.appendChild(s);
  }

  function tryLocalThenCdn(){
    // Try to load local Chart.js UMD
    loadScript(localChart, function(){
      // Chart loaded from local file; prefer the bundled adapter (includes date-fns) if present
      loadScript(localAdapterBundle, function(){ /* bundled adapter loaded */ }, function(){
        // No bundled adapter; try separate local date-fns then adapter (no XHR to avoid CORS)
        loadScript(localDateFns, function(){
          loadScript(localAdapter, function(){ /* adapter loaded */ }, function(){ console.info('Local date adapter failed to load'); });
        }, function(){
          console.info('Local date-fns failed to load');
          // still attempt to load adapter (it may include a bundled date-fns in some builds)
          loadScript(localAdapter, function(){}, function(){ console.info('Local date adapter failed to load'); });
        });
      });
      if (typeof Chart === 'undefined') { console.warn('Local chart did not define Chart; falling back to CDN'); loadCdn(); }
    }, function(){
      // local Chart failed; fallback to CDN
      loadCdn();
    });
  }

  function loadCdn(){
    var s2 = document.createElement('script'); s2.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    s2.onload = function(){
      // after CDN Chart loads, attempt to load date-fns and adapter from CDN as well
      loadScript('https://cdn.jsdelivr.net/npm/date-fns', function(){
        loadScript('https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns', function(){}, function(){ console.warn('CDN adapter failed to load'); });
      }, function(){
        console.warn('CDN date-fns failed to load');
        loadScript('https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns', function(){}, function(){ console.warn('CDN adapter failed to load'); });
      });
      if (typeof Chart === 'undefined') console.error('CDN Chart.js loaded but Chart is undefined');
    };
    s2.onerror = function(){ console.error('Failed to load Chart.js from CDN'); };
    document.head.appendChild(s2);
  }

  tryLocalThenCdn();
})();
